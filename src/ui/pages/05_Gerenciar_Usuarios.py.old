import streamlit as st
from src.services.user_service import UserService
from src.services.dev_service import DevService
from src.core.auth_middleware import require_auth
from src.models.UserRole import UserRole

# Prote√ß√£o da p√°gina
require_auth(allowed_roles=['admin'])

st.title("üë• Gerenciar Usu√°rios")

user_service = UserService()
dev_service = DevService()

# --- SE√á√ÉO 1: CADASTRO ---
with st.expander("‚ûï Cadastrar Novo Usu√°rio"):
    with st.form("form_registro", clear_on_submit=True):
        col1, col2 = st.columns(2)
        with col1:
            new_lgn = st.text_input("Login")
            new_nom = st.text_input("Nome")
        with col2:
            new_pwd = st.text_input("Senha", type="password")
            new_prm = st.selectbox("Permiss√£o", options=UserRole.list())
        
        if st.form_submit_button("Salvar", type="primary"):
            success, msg = user_service.create_user(new_lgn, new_nom, new_pwd, new_prm)
            if success:
                st.success("Usu√°rio criado!")
                st.rerun()
            else:
                st.error(msg)

st.divider()

# --- SE√á√ÉO 2: LISTAGEM ---
st.subheader("üìã Usu√°rios do Sistema")
usuarios = user_service.get_all_users()

if not usuarios:
    st.info("Nenhum usu√°rio encontrado.")
else:
    for u in usuarios:
        with st.container(border=True):
            c1, c2, c3 = st.columns([2, 1, 1.5])
            
            c1.write(f"**{u['UsrNom']}**")
            c1.caption(f"Login: {u['UsrLgn']} | N√≠vel: {u['UsrPrm'].upper()}")
            
            # Coluna 3 agora ter√° dois bot√µes pequenos
            btn_col1, btn_col2 = c3.columns(2)
            
            # BOT√ÉO 1: Promo√ß√£o / Detalhes
            is_dev = dev_service.check_if_exists(u['UsrCod'])
            if not is_dev:
                if btn_col1.button("üöÄ Dev", key=f"prom_{u['UsrCod']}", help="Tornar Desenvolvedor"):
                    dev_service.create_dev_from_user(u['UsrCod'], u['UsrNom'])
                    st.toast(f"Usu√°rio {u['UsrNom']} promovido a Desenvolvedor!", icon="üöÄ")
                    st.rerun()
            else:
                btn_col1.button("üîç Ver", key=f"det_{u['UsrCod']}", disabled=True)

            # BOT√ÉO 2: Reset de Senha
            if btn_col2.button("üîë Reset", key=f"pw_{u['UsrCod']}", help="Resetar para senha padr√£o '123'"):
                if user_service.reset_password(u['UsrCod']):
                    st.toast(f"Senha de {u['UsrNom']} resetada para '123'!", icon="üîê")
                else:
                    st.error("Erro ao resetar senha.")