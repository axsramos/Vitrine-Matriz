import hashlib
from src.models.UserModel import UserModel
from src.models.UserProfileModel import UserProfileModel

class UserService:
    def __init__(self):
        self.model = UserModel()
    
    def get_all_users(self):
        """
        Retorna todos os utilizadores utilizando a lógica do CrudMixin.
        """
        try:
            # O read_all do CrudMixin já trata a conexão e retorna a lista de dicts
            # Podemos passar filtros ou ordenação se o seu Mixin suportar
            return self.model.read_all() 
        except Exception as e:
            print(f"Erro ao ler utilizadores via Mixin: {e}")
            return []

    def _hash_password(self, password):
        """Gera hash SHA256 para comparar com o banco."""
        return hashlib.sha256(password.encode()).hexdigest()
    
    def login(self, username, password):
        model = UserModel()
        password_hash = self._hash_password(password)
        
        # Busca usuário ativo (UsrAudDlt IS NULL)
        # Atenção: Usando UsrPrm se precisar validar permissão depois
        users = model.read_all(
            where="UsrLgn = ? AND UsrPwd = ? AND UsrAudDlt IS NULL", 
            params=(username, password_hash)
        )
        
        return users[0] if users else None

    def get_user_profile(self, user_id):
        model = UserProfileModel()
        profiles = model.read_all(where="UsrPrfUsrCod = ?", params=(user_id,))
        return profiles[0] if profiles else {}
    
    def update_profile(self, user_id, profile_data: dict):
        """Cria ou Atualiza o perfil."""
        model = UserProfileModel()
        
        # Verifica se já existe
        existing = model.read_all(where="UsrPrfUsrCod = ?", params=(user_id,))
        
        if existing:
            # Atualiza objeto existente
            current_data = existing[0]
            model = UserProfileModel(**current_data)
            
            # Atualiza campos recebidos
            for k, v in profile_data.items():
                if hasattr(model, k):
                    setattr(model, k, v)
        else:
            # Cria novo
            model = UserProfileModel(**profile_data)
            model.UsrPrfUsrCod = user_id
            
        return model.save()
    
    def create_user(self, login, nome, senha, permissao):
        """
        Cria um novo usuário utilizando o método .save() do CrudMixin.
        """
        try:
            # Em vez de passar um dicionário para um método create(), 
            # alimentamos os atributos do objeto conforme definido no CrudMixin
            new_user = UserModel()
            new_user.UsrLgn = login
            new_user.UsrNom = nome
            new_user.UsrPwd = self._hash_password(senha)
            new_user.UsrPrm = permissao
            new_user.UsrAudUsr = "admin"
            
            # O .save() identifica que a PK está nula e executa o INSERT
            if new_user.save():
                return True, "Usuário cadastrado com sucesso!"
            return False, "Falha ao salvar usuário no banco."
            
        except Exception as e:
            return False, f"Erro no UserService: {str(e)}"

    def update_user_permission(self, usr_id, new_role):
        """Atualiza a permissão buscando o objeto e salvando a alteração."""
        try:
            if self.model.read_by_field("UsrCod", usr_id): # Usa o método do seu Mixin
                self.model.UsrPrm = new_role
                return self.model.save()
            return False
        except Exception as e:
            print(f"Erro ao atualizar permissão: {e}")
            return False
            
    def get_user_by_id(self, usr_id):
        # Utiliza o read_all com filtro conforme seu Mixin
        res = self.model.read_all(where="UsrCod = ?", params=(usr_id,))
        return res[0] if res else None
    
    def reset_password(self, usr_id):
        """
        Define a senha do usuário para o padrão '123' com criptografia.
        """
        try:
            # 1. Busca o registro atual
            results = self.model.read_all(where="UsrCod = ?", params=(usr_id,))
            if results:
                # 2. Carrega no objeto do Model para o Mixin entender que é um UPDATE
                user_obj = UserModel(**results[0])
                
                # 3. Aplica o hash no valor padrão '123'
                # Certifique-se de que o método _hash_password está definido na classe
                user_obj.UsrPwd = self._hash_password("123")
                
                # 4. Persiste no banco
                return user_obj.save()
            return False
        except Exception as e:
            print(f"Erro ao renovar senha: {e}")
            return False
     
    def apply_permission(self, usr_id, new_role):
        results = self.model.read_all(where="UsrCod = ?", params=(usr_id,))
        if results:
            user_obj = UserModel(**results[0])
            user_obj.UsrPrm = new_role
            return user_obj.save()
        return False